<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Evaluations — Royal Vending</title>
  <link rel="stylesheet" href="assets/css/style.css">

  <style>
    .modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: white;
      padding: 20px;
      width: 450px;
      border-radius: 8px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .skill-row {
      margin-bottom: 12px;
    }
    .skill-row label {
      font-weight: bold;
      display: block;
    }
    .skill-row input[type=radio] {
      margin-right: 6px;
      margin-left: 4px;
    }
    .notes {
      width: 100%;
      margin-top: 6px;
      height: 45px;
      display: none;
    }
  </style>
</head>

<body>

<header>
  <img src="assets/images/logo.png" class="logo">
  <nav>
    <a href="dashboard.html">Dashboard</a>
    <a href="evaluations.html" class="active">Evaluations</a>
    <a href="coaching.html">Coaching Logs</a>
    <a href="reports.html">Reports</a>
    <a href="admin.html">Admin</a>
    <button id="logoutBtn">Logout</button>
  </nav>
</header>

<main>
  <h1>Evaluations</h1>

  <!-- FILTER BAR -->
  <div class="filter-bar">
    <select id="filterMember"><option value="">Team Member</option></select>
    <select id="filterEvaluator"><option value="">Evaluator</option></select>
    <input type="text" id="filterSearch" placeholder="Search...">
    <button id="applyFilters">Search</button>
  </div>

  <button id="openEvalModal">+ Add New Evaluation</button>

  <!-- TABLE -->
  <table id="evalTable" border="1">
    <thead>
      <tr>
        <th>Team Member</th>
        <th>Evaluator</th>
        <th>% Score</th>
        <th>✔</th>
        <th>❌</th>
        <th>View</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<!-- EVALUATION MODAL -->
<div class="modal-bg" id="evalModal">
  <div class="modal">
    <h3>New Evaluation</h3>

    <label>Date of Evaluation</label>
    <input type="date" id="evDate">

    <label>Team Member</label>
    <select id="evMember"></select>

    <label>Evaluator</label>
    <select id="evEvaluator"></select>

    <label>Call ID / Email Link</label>
    <input type="text" id="evCallId" placeholder="Paste call ID or email link">

    <label>Summary</label>
    <textarea id="evSummary" placeholder="Brief summary"></textarea>

    <h4>Skill Check (✔️ Meets | ❌ Needs Improvement)</h4>

    <div class="skill-row">
      <label>Communication</label>
      <label><input type="radio" name="comm" value="yes"> ✔️</label>
      <label><input type="radio" name="comm" value="no"> ❌</label>
      <textarea id="commNotes" class="notes" placeholder="Reason for ❌"></textarea>
    </div>

    <div class="skill-row">
      <label>Relationship Building</label>
      <label><input type="radio" name="rel" value="yes"> ✔️</label>
      <label><input type="radio" name="rel" value="no"> ❌</label>
      <textarea id="relNotes" class="notes" placeholder="Reason for ❌"></textarea>
    </div>

    <div class="skill-row">
      <label>Problem-Solving</label>
      <label><input type="radio" name="prob" value="yes"> ✔️</label>
      <label><input type="radio" name="prob" value="no"> ❌</label>
      <textarea id="probNotes" class="notes" placeholder="Reason for ❌"></textarea>
    </div>

    <div class="skill-row">
      <label>Task Management</label>
      <label><input type="radio" name="task" value="yes"> ✔️</label>
      <label><input type="radio" name="task" value="no"> ❌</label>
      <textarea id="taskNotes" class="notes" placeholder="Reason for ❌"></textarea>
    </div>

    <div class="skill-row">
      <label>Customer Service</label>
      <label><input type="radio" name="cust" value="yes"> ✔️</label>
      <label><input type="radio" name="cust" value="no"> ❌</label>
      <textarea id="custNotes" class="notes" placeholder="Reason for ❌"></textarea>
    </div>

    <div class="skill-row">
      <label>Analytical & Reporting Skills</label>
      <label><input type="radio" name="ana" value="yes"> ✔️</label>
      <label><input type="radio" name="ana" value="no"> ❌</label>
      <textarea id="anaNotes" class="notes" placeholder="Reason for ❌"></textarea>
    </div>

    <div class="skill-row">
      <label>Accuracy & Attention to Detail</label>
      <label><input type="radio" name="acc" value="yes"> ✔️</label>
      <label><input type="radio" name="acc" value="no"> ❌</label>
      <textarea id="accNotes" class="notes" placeholder="Reason for ❌"></textarea>
    </div>

    <label>Total Score</label>
    <input id="evTotal" readonly>

    <label>Feedback</label>
    <textarea id="evFeedback" placeholder="Overall feedback"></textarea>

    <button id="submitEval">Submit Evaluation</button>
    <button id="closeEvalModal">Cancel</button>
  </div>
</div>

<!-- FIREBASE SCRIPT -->
<script type="module">
  import { listEvaluations, addEvaluation, adminListAll, logoutUser } from './api-firebase.js';

  if (!sessionStorage.getItem("rvc_user")) window.location.href = "index.html";

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await logoutUser();
    sessionStorage.removeItem("rvc_user");
    window.location.href = "index.html";
  });

  // Load members/users into dropdowns
  async function loadFilters() {
    const data = await adminListAll();

    data.members.forEach(m => {
      filterMember.innerHTML += `<option value="${m.name || m[0]}">${m.name || m[0]}</option>`;
      evMember.innerHTML += `<option value="${m.name || m[0]}">${m.name || m[0]}</option>`;
    });

    data.users.forEach(u => {
      filterEvaluator.innerHTML += `<option value="${u.name}">${u.name}</option>`;
      evEvaluator.innerHTML += `<option value="${u.name}">${u.name}</option>`;
    });
  }

  // Load table data
  async function loadEvaluations(listOverride = null) {
    const list = listOverride || await listEvaluations();
    const tbody = document.querySelector("#evalTable tbody");
    tbody.innerHTML = "";

    list.forEach(r => {
      const skills = r.skills ? Object.values(r.skills) : [];
      const checks = skills.filter(s => s.value === "✔️").length;
      const xes = skills.filter(s => s.value === "❌").length;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.member}</td>
        <td>${r.evaluator}</td>
        <td>${r.total}</td>
        <td>${checks}</td>
        <td>${xes}</td>
        <td><button onclick="alert('View feature coming soon')">View</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Apply filters
  applyFilters.addEventListener("click", async () => {
    let list = await listEvaluations();

    if (filterMember.value)
      list = list.filter(e => e.member === filterMember.value);

    if (filterEvaluator.value)
      list = list.filter(e => e.evaluator === filterEvaluator.value);

    if (filterSearch.value)
      list = list.filter(e =>
        JSON.stringify(e).toLowerCase().includes(filterSearch.value.toLowerCase())
      );

    loadEvaluations(list);
  });

  // Modal controls
  const modal = document.getElementById("evalModal");
  openEvalModal.onclick = () => modal.style.display = "flex";
  closeEvalModal.onclick = () => modal.style.display = "none";

  const skillPairs = [
    ["comm","commNotes"],
    ["rel","relNotes"],
    ["prob","probNotes"],
    ["task","taskNotes"],
    ["cust","custNotes"],
    ["ana","anaNotes"],
    ["acc","accNotes"]
  ];

  skillPairs.forEach(([name, notesId]) => {
    document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
      radio.addEventListener("change", () => {
        const notes = document.getElementById(notesId);
        if (radio.value === "no") notes.style.display = "block";
        else { notes.style.display = "none"; notes.value = ""; }
        calculateFinalScore();
      });
    });
  });

  function calculateFinalScore() {
    let correct = 0;
    skillPairs.forEach(([name]) => {
      const selected = document.querySelector(`input[name="${name}"]:checked`);
      if (selected && selected.value === "yes") correct++;
    });
    evTotal.value = ((correct / 7) * 100).toFixed(2) + "%";
  }

  // Submit evaluation
  submitEval.addEventListener("click", async () => {
    const skillData = {};
    let correct = 0;

    for (const [name, notesId] of skillPairs) {
      const selected = document.querySelector(`input[name="${name}"]:checked`);
      const notes = document.getElementById(notesId).value;

      if (!selected) return alert("Please answer all skills ✔️ / ❌");
      if (selected.value === "no" && !notes.trim()) return alert("Provide notes for ❌");

      if (selected.value === "yes") correct++;

      skillData[name] = {
        value: selected.value === "yes" ? "✔️" : "❌",
        notes
      };
    }

    const total = ((correct / 7) * 100).toFixed(2) + "%";

    const payload = {
      member: evMember.value,
      evaluator: evEvaluator.value,
      date: evDate.value,
      callId: evCallId.value,
      summary: evSummary.value,
      feedback: evFeedback.value,
      total,
      skills: skillData,
      createdAt: new Date()
    };

    await addEvaluation(payload);
    alert("Evaluation saved!");
    modal.style.display = "none";
    loadEvaluations();
  });

  // Initialize page
  loadFilters();
  loadEvaluations();

</script>

</body>
</html>
